<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bezier Curve</title>
</head>
<body>
    <canvas id="canvas" width="1280" height="720"></canvas>
    <script>

        var canvas = document.getElementById(`canvas`);
        var ctx = canvas.getContext(`2d`);
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        var canvasWidth = canvas.width;
        var canvasHeight = canvas.height;
        var canvasData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);

        class Point {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }

        let p1, p2, p3, p4, selectedPoint, previousPoint;
        const outboundsPoint = new Point(0, 0);

        let oldWidth = canvasWidth, oldHeight = canvasHeight;

        window.addEventListener('resize', resizeCanvas, false);

        let moved = false;

        let downListener = () => {
            moved = true;
            choosePoint(event.pageX, event.pageY);
        }
        document.addEventListener('mousedown', downListener)

        let moveListener = () => {
            if (moved) {
                movePoint(event);
            }
        }
        document.addEventListener('mousemove', moveListener)
        
        let upListener = () => {
             moved = false;
             selectedPoint = outboundsPoint;
        }
        document.addEventListener('mouseup', upListener)

        function calculateDistance(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
        }

        function choosePoint(x, y) {
            let pDist = [];
            pDist[0] = calculateDistance(x, y, p1.x, p1.y);
            pDist[1] = calculateDistance(x, y, p2.x, p2.y);
            pDist[2] = calculateDistance(x, y, p3.x, p3.y);
            pDist[3] = calculateDistance(x, y, p4.x, p4.y);

            const min = Math.min(...pDist);
            const index = pDist.indexOf(min);

            if (min < 50) {
                switch (index) {
                    case 0:
                        selectedPoint = p1;
                        break;
                        
                    case 1:
                        selectedPoint = p2;
                        break;
                        
                    case 2:
                        selectedPoint = p3;
                        break;
                        
                    case 3:
                        selectedPoint = p4;
                        break;
                }
            }
        }

        function movePoint(event) {
            var bounds = event.target.getBoundingClientRect();

            selectedPoint.x = event.pageX - bounds.left - scrollX;
            selectedPoint.y = event.pageY - bounds.top - scrollY;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            redraw();
        }

        function resizeCanvas() {
            ctx.canvas.width  = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
            redraw();
        }

        function drawPixel (point) {
            // ctx.fillRect(point.x, point.y, 1, 1);
            drawLine(previousPoint, point);
            previousPoint = point;
        }

        function drawLine(start, end, stroke = 'black', width = 1) {
            if (stroke) {
                ctx.strokeStyle = stroke;
            }

            if (width) {
                ctx.lineWidth = width;
            }

            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
        }

        function getRandomNumber(min, max) {
            return Math.random() * (max - min) + min;
        }

        function interpolatePoint(first, second, u) {
            return new Point((second.x - first.x) * u + first.x, (second.y - first.y) * u + first.y);
        }

        function init() {
            p1 = new Point(getRandomNumber(100, canvas.width / 2), getRandomNumber(canvas.height / 2, canvas.height - 100));
            p2 = new Point(getRandomNumber(100, canvas.width / 2), getRandomNumber(100, canvas.height / 2));
            p3 = new Point(getRandomNumber(canvas.width / 2, canvas.width - 100), getRandomNumber(100, canvas.height / 2));
            p4 = new Point(getRandomNumber(canvas.width / 2, canvas.width - 100), getRandomNumber(canvas.height / 2, canvas.height - 100));
        }

        function drawPoint(u) {
            
            let p12 = interpolatePoint(p1, p2, u);
            let p23 = interpolatePoint(p2, p3, u);
            let p34 = interpolatePoint(p3, p4, u);

            let p123 = interpolatePoint(p12, p23, u);
            let p234 = interpolatePoint(p23, p34, u);

            let p1234 = interpolatePoint(p123, p234, u);

            // drawLine(p12, p23);
            // drawLine(p23, p34);
            // drawLine(p123, p234);
            drawPixel(p1234);
        }

        function drawCurve() {
            drawLine(p1, p2);
            drawLine(p2, p3);
            drawLine(p3, p4);

            previousPoint = p1;

            var u = 0;
            while (u <= 1) {
                drawPoint(u);
                u += 0.005;
            }
        }
        
        function scalePoint(point) {
            point.x = point.x * canvasWidth / oldWidth;
            point.y = point.y * canvasHeight / oldHeight;
        }

        function redraw() {
            scalePoint(p1);
            scalePoint(p2);
            scalePoint(p3);
            scalePoint(p4);

            drawCurve();

            oldWidth = canvasWidth;
            oldHeight = canvasHeight;
        }

        init();
        drawCurve();
    </script>
</body>
</html>