<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bezier Curve</title>
</head>
<body>
    <canvas id="canvas" width="1280" height="720"></canvas>
    <script>

        let p1, p2, p3, p4;

        var canvas = document.getElementById(`canvas`);
        var ctx = canvas.getContext(`2d`);
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerHeight;
        var canvasWidth = canvas.width;
        var canvasHeight = canvas.height;
        var canvasData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);

        let oldWidth = canvasWidth, oldHeight = canvasHeight;

        window.addEventListener('resize', resizeCanvas, false);
        // document.onclick = movePoint;

        let moved = false;

        let downListener = () => {
            moved = true;
        }
        document.addEventListener('mousedown', downListener)

        let moveListener = () => {
            if (moved) {
                movePoint(event);
            }
        }
        document.addEventListener('mousemove', moveListener)
        
        let upListener = () => {
             moved = false;
        }
        document.addEventListener('mouseup', upListener)

        function calculateDistance(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
        }

        function movePoint(event) {
            var bounds = event.target.getBoundingClientRect();

            let pDist = [];
            pDist[0] = calculateDistance(event.pageX, event.pageY, p1[0], p1[1]);
            pDist[1] = calculateDistance(event.pageX, event.pageY, p2[0], p2[1]);
            pDist[2] = calculateDistance(event.pageX, event.pageY, p3[0], p3[1]);
            pDist[3] = calculateDistance(event.pageX, event.pageY, p4[0], p4[1]);

            const min = Math.min(...pDist);
            const index = pDist.indexOf(min);

            // TODO: Fix bug where points can swap during overlap
            if (min < 500) {
                switch (index) {
                    case 0:
                        p1[0] = event.pageX - bounds.left - scrollX;
                        p1[1] = event.pageY - bounds.top - scrollY;
                        break;
                        
                    case 1:
                        p2[0] = event.pageX - bounds.left - scrollX;
                        p2[1] = event.pageY - bounds.top - scrollY;
                        break;
                        
                    case 2:
                        p3[0] = event.pageX - bounds.left - scrollX;
                        p3[1] = event.pageY - bounds.top - scrollY;
                        break;
                        
                    case 3:
                        p4[0] = event.pageX - bounds.left - scrollX;
                        p4[1] = event.pageY - bounds.top - scrollY;
                        break;
                }
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            redraw();
        }

        function resizeCanvas() {
            ctx.canvas.width  = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
            redraw();
        }

        // That's how you define the value of a pixel
        function drawPixel (x, y) {
            ctx.fillRect(x, y, 1, 1);
        }

        function drawLine(begin, end, stroke = 'black', width = 1) {
            if (stroke) {
                ctx.strokeStyle = stroke;
            }

            if (width) {
                ctx.lineWidth = width;
            }

            ctx.beginPath();
            ctx.moveTo(...begin);
            ctx.lineTo(...end);
            ctx.stroke();
        }

        function getRandomNumber(min, max) {
            return Math.random() * (max - min) + min;
        }

        function interpolatePoint(first, second, u) {
            return (first.map((valueA, indexInA) => valueA - second[indexInA])).map(x =>  x * u).map((valueA, indexInA) => valueA + second[indexInA]);
        }

        function init() {
            p1 = [getRandomNumber(100, canvas.width / 2), getRandomNumber(canvas.height / 2, canvas.height - 100)];
            p2 = [getRandomNumber(100, canvas.width / 2), getRandomNumber(100, canvas.height / 2)];
            p3 = [getRandomNumber(canvas.width / 2, canvas.width - 100), getRandomNumber(100, canvas.height / 2)];
            p4 = [getRandomNumber(canvas.width / 2, canvas.width - 100), getRandomNumber(canvas.height / 2, canvas.height - 100)];
        }

        function drawPoint(u) {
            
            let p12 = interpolatePoint(p1, p2, u);
            let p23 = interpolatePoint(p2, p3, u);
            let p34 = interpolatePoint(p3, p4, u);

            let p123 = interpolatePoint(p12, p23, u);
            let p234 = interpolatePoint(p23, p34, u);

            let p1234 = interpolatePoint(p123, p234, u);

            // drawLine(p12, p23);
            // drawLine(p23, p34);
            // drawLine(p123, p234);
            drawPixel(p1234[0], p1234[1]);
        }

        function drawCurve() {
            drawLine(p1, p2);
            drawLine(p2, p3);
            drawLine(p3, p4);

            var u = 0;
            while (u <= 1) {
                drawPoint(u);
                u += 0.0005;
            }
        }
        
        function redraw() {
            p1 = [p1[0] * canvasWidth / oldWidth, p1[1] * canvasWidth / oldWidth]
            p2 = [p2[0] * canvasWidth / oldWidth, p2[1] * canvasWidth / oldWidth]
            p3 = [p3[0] * canvasWidth / oldWidth, p3[1] * canvasWidth / oldWidth]
            p4 = [p4[0] * canvasWidth / oldWidth, p4[1] * canvasWidth / oldWidth]

            drawCurve();

            oldWidth = canvasWidth;
            oldHeight = canvasHeight;
        }

        init();
        drawCurve();
    </script>
</body>
</html>